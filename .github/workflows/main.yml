name: Sync Upstream Release & Code

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout your repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ---------------------------
    # 1. 获取上游 Release 信息
    # ---------------------------
    - name: Get latest upstream release info
      id: upstream
      uses: actions/github-script@v7
      with:
        script: |
          const release = await github.rest.repos.getLatestRelease({
            owner: "mack-a",
            repo: "v2ray-agent"
          });
          core.setOutput("tag", release.data.tag_name);
          core.setOutput("name", release.data.name);
          core.setOutput("body", release.data.body);
          core.setOutput("prerelease", release.data.prerelease);
          core.setOutput("assets", JSON.stringify(release.data.assets));

    # ---------------------------
    # 2. 下载 Release 资产（如果有）
    # ---------------------------
    - name: Download assets (if any)
      id: download
      run: |
        mkdir -p upstream-release
        echo '${{ steps.upstream.outputs.assets }}' > assets.json
        urls=$(jq -r '.[].browser_download_url' assets.json)

        if [ -z "$urls" ]; then
          echo "no_assets=true" >> $GITHUB_ENV
          echo "No assets found in upstream release."
        else
          echo "no_assets=false" >> $GITHUB_ENV
          for url in $urls; do
            echo "Downloading: $url"
            wget -q "$url" -P upstream-release
          done
          echo "Downloaded files:"
          ls -lh upstream-release
        fi

    # ---------------------------
    # 3. 同步上游代码（master 分支）
    # ---------------------------
    - name: Sync upstream code (ignore .md files) 
      run: | 
         git remote add upstream https://github.com/mack-a/v2ray-agent.git || true 
         git fetch upstream 
         
         # 切换到 main 分支 
         git checkout master || git checkout -b master # 拉取上游代码到临时目录 
         rm -rf upstream-tmp 
         mkdir upstream-tmp 
         git --work-tree=upstream-tmp checkout upstream/master -- . 
         
         # 删除所有 .md 文件 
         find upstream-tmp -name "*.md" -type f -delete 
         
         # 将过滤后的文件同步到当前仓库 
         cp -r upstream-tmp/* . 
         
         git add . 
         git commit -m "Sync upstream code (ignore .md files)" || true 
         git push origin master

    # ---------------------------
    # 4. 上传 Release（如果有 assets）
    # ---------------------------
    - name: Upload release (skip if no assets)
      if: env.no_assets == 'false'
      uses: svenstaro/upload-release-action@v2
      with:
        file: upstream-release/*
        file_glob: true
        tag: ${{ steps.upstream.outputs.tag }}
        release_name: ${{ steps.upstream.outputs.name }}
        body: ${{ steps.upstream.outputs.body }}
        prerelease: ${{ steps.upstream.outputs.prerelease }}
        overwrite: true

    # ---------------------------
    # 5. 创建空 Release（如果没有 assets）
    # ---------------------------
    - name: Create release without assets
      if: env.no_assets == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.upstream.outputs.tag }}
        name: ${{ steps.upstream.outputs.name }}
        body: ${{ steps.upstream.outputs.body }}
        prerelease: ${{ steps.upstream.outputs.prerelease }}
